<!DOCTYPE html>
<html>
<head>
    <title>WebTransport Form Test</title>
</head>
<body>
    <h1>WebTransport File Upload Test</h1>
    
    <h2>File Upload</h2>
    <input type="file" id="fileInput"><br><br>
    <button onclick="uploadFile()">Upload File</button>
    
    <div id="status"></div>

    <script>
        let statusDiv = document.getElementById('status');
        let serverUrl = 'https://127.0.0.1:9090/uploadFile'
        let serverHash = new Uint8Array(%%CERTHASH%%)

        async function establishSession(url, hash) {
            result = new WebTransport(url, {
                "serverCertificateHashes": [{
                    "algorithm": "sha-256",
                    "value": hash
                }]
            });

            // Optionally, set up functions to respond to
            // the connection closing:
            result.closed.then(() => {
                console.log(`The HTTP/3 connection to ${url} closed gracefully.`);
            }).catch((error) => {
                console.error(`The HTTP/3 connection to ${url} closed due to ${error}.`);
            });

            // Once .ready fulfills, the connection can be used.
            await result.ready;
            return result;
        }

        // File upload
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const transport = await establishSession(serverUrl + '?fileName=' + file.name, serverHash);
            
            if (!file) {
                alert('Please select a file');
                return;
            }

            try {
                const stream = await transport.createBidirectionalStream();
                const writer = stream.writable.getWriter();
                
                const reader = file.stream().getReader();
                statusDiv.innerHTML += '<p>Uploading file: ' + file.name + '</p>';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    await writer.write(value);
                }
                
                await writer.close();
                statusDiv.innerHTML += '<p>File upload complete!</p>';
                transport.close();
            } catch (error) {
                statusDiv.innerHTML += '<p>Error uploading file: ' + error.message + '</p>';
                transport.close();
            }
        }
    </script>
</body>
</html>`